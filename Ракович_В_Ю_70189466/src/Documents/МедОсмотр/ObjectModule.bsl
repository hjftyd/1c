Процедура ОбработкаПроведения(Отказ, РежимПроведения)
    
    Попытка
        // Проверяем обязательные поля перед проведением
        Если Не ЗначениеЗаполнено(Студент) Тогда
            ВызватьИсключение "Не указан студент!";
        КонецЕсли;
        
        Если Не ЗначениеЗаполнено(Дата) Тогда
            ВызватьИсключение "Не указана дата документа!";
        КонецЕсли;
        
        // Инициализируем движения
        Движения.ИсторияПоказателейЗдоровья.Записывать = Истина;
        
        // Получаем предопределенные показатели
        ПоказательРост = Справочники.ПоказателиЗдоровья.ПоказательРост;
        ПоказательВес = Справочники.ПоказателиЗдоровья.ПоказательВес;
        
        // Запись роста
        Если ЗначениеЗаполнено(Рост) Тогда
            Если ПоказательРост.Пустая() Тогда
                ВызватьИсключение "Не найден показатель 'Рост' в справочнике ПоказателиЗдоровья!";
            КонецЕсли;
            
            Движение = Движения.ИсторияПоказателейЗдоровья.Добавить();
            ЗаполнитьЗначенияСвойств(Движение, Новый Структура(
                "Период, Студент, Показатель, Значение, Измерявший, ДокументОснования", 
                Дата, Студент, ПоказательРост, Рост, МедРаботник, Ссылка
            ));
        КонецЕсли;
        
        // Запись веса
        Если ЗначениеЗаполнено(Вес) Тогда
            Если ПоказательВес.Пустая() Тогда
                ВызватьИсключение "Не найден показатель 'Вес' в справочнике ПоказателиЗдоровья!";
            КонецЕсли;
            
            Движение = Движения.ИсторияПоказателейЗдоровья.Добавить();
            ЗаполнитьЗначенияСвойств(Движение, Новый Структура(
                "Период, Студент, Показатель, Значение, Измерявший, ДокументОснования", 
                Дата, Студент, ПоказательВес, Вес, МедРаботник, Ссылка
            ));
        КонецЕсли;
        
        // Дополнительно: запись ИМТ если есть рост и вес
        Если ЗначениеЗаполнено(Рост) И ЗначениеЗаполнено(Вес) Тогда
            ИМТ = РассчитатьИМТ(Рост, Вес);
            ПоказательИМТ = Справочники.ПоказателиЗдоровья.НайтиПоНаименованию("Индекс массы тела");
            
            Если НЕ ПоказательИМТ.Пустая() Тогда
                Движение = Движения.ИсторияПоказателейЗдоровья.Добавить();
                ЗаполнитьЗначенияСвойств(Движение, Новый Структура(
                    "Период, Студент, Показатель, Значение, Измерявший, ДокументОснования", 
                    Дата, Студент, ПоказательИМТ, ИМТ, МедРаботник, Ссылка
                ));
            КонецЕсли;
        КонецЕсли;
        
    Исключение
        // Отменяем проведение при ошибке
        Отказ = Истина;
        Сообщить(ОписаниеОшибки(), СтатусСообщения.Важное);
    КонецПопытки;
    
КонецПроцедуры

// Вспомогательная функция расчета ИМТ
Функция РассчитатьИМТ(РостВСм, ВесВКг)
    Если РостВСм <= 0 Тогда
        Возврат 0;
    КонецЕсли;
    
    РостВМетрах = РостВСм / 100;
    Возврат ВесВКг / (РостВМетрах * РостВМетрах);
КонецФункции