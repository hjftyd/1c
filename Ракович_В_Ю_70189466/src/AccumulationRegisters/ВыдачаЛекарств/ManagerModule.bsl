// Получить историю выдачи лекарств студенту
Функция ПолучитьИсториюВыдачиЛекарств(Студент, ДатаНачала, ДатаОкончания) Экспорт
     
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ
    |    ВыдачаЛекарств.ДатаВыдачи,
    |    ВыдачаЛекарств.Лекарство.Наименование,
    |    ВыдачаЛекарств.Количество,
    |    ВыдачаЛекарств.СпособВыдачи,
    |    ВыдачаЛекарств.Выдавший
    |ИЗ
    |    РегистрНакопления.ВыдачаЛекарств КАК ВыдачаЛекарств
    |ГДЕ
    |    ВыдачаЛекарств.Студент = &Студент
    |    И ВыдачаЛекарств.ДатаВыдачи МЕЖДУ &ДатаНачала И &ДатаОкончания
    |УПОРЯДОЧИТЬ ПО
    |    ВыдачаЛекарств.ДатаВыдачи УБЫВ";
    
    Запрос.УстановитьПараметр("Студент", Студент);
    Запрос.УстановитьПараметр("ДатаНачала", ДатаНачала);
    Запрос.УстановитьПараметр("ДатаОкончания", ДатаОкончания);
    
    Возврат Запрос.Выполнить().Выгрузить();
    
КонецФункции

// Проверить остатки лекарств
Функция ПолучитьОстаткиЛекарств(НаДату) Экспорт
    
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ
    |    Лекарства.Наименование КАК Лекарство,
    |    Лекарства.ЕдиницаИзмерения,
    |    Лекарства.НормаОстатка,
    |    ВЫБОР
    |        КОГДА Лекарства.НормаОстатка > 0
    |            ТОГДА Лекарства.НормаОстатка - ВЫРАЗИТЬ(СУММА(ВыдачаЛекарств.Количество) КАК ЧИСЛО(15, 2))
    |        ИНАЧЕ 0
    |    КОНЕЦ КАК Остаток
    |ИЗ
    |    Справочник.Лекарства КАК Лекарства
    |        ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ВыдачаЛекарств КАК ВыдачаЛекарств
    |        ПО Лекарства.Ссылка = ВыдачаЛекарств.Лекарство
    |            И ВыдачаЛекарств.ДатаВыдачи <= &НаДату
    |
    |СГРУППИРОВАТЬ ПО
    |    Лекарства.Наименование,
    |    Лекарства.ЕдиницаИзмерения,
    |    Лекарства.НормаОстатка
    |
    |ИМЕЮЩИЕ
    |    ВЫБОР
    |        КОГДА Лекарства.НормаОстатка > 0
    |            ТОГДА Лекарства.НормаОстатка - ВЫРАЗИТЬ(СУММА(ВыдачаЛекарств.Количество) КАК ЧИСЛО(15, 2))
    |        ИНАЧЕ 0
    |    КОНЕЦ < Лекарства.НормаОстатка * 0.2
    |
    |УПОРЯДОЧИТЬ ПО
    |    Остаток";
    
    Запрос.УстановитьПараметр("НаДату", НаДату);
    
    Возврат Запрос.Выполнить().Выгрузить();
    
КонецФункции